name: Self-assign + enforce single assignee + (optional) lock

on:
  issue_comment:
    types: [created]
  issues:
    types: [assigned]

permissions:
  issues: write

jobs:
  self-assign:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Assign commenter on /assign me
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment.body || '').trim().toLowerCase();
            const isCommand =
              body === '/assign me' ||
              body === '/assign';

            if (!isCommand) return;

            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;

            // Only let users claim unassigned issues
            const assignees = context.payload.issue.assignees || [];
            if (assignees.length > 0) return;

            const login = context.payload.comment.user.login;

            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number: issueNumber,
              assignees: [login],
            });

  enforce-and-lock:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Keep only first assignee and lock (optional)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const assignees = context.payload.issue.assignees || [];

            // Enforce single assignee
            if (assignees.length > 1) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: [assignees[0].login],
              });
            }

            // OPTIONAL: Locking here will stop further comments (including future /assign attempts).
            // Remove this block if you want discussion to continue.
            await github.rest.issues.lock({
              owner,
              repo,
              issue_number: issueNumber,
              lock_reason: "resolved",
            });
